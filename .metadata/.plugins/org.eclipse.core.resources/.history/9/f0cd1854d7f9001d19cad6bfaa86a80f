#include "W25Q64Drv.h"



HAL_StatusTypeDef W25Q64_Transmit_Data(MEMORY * this,uint8_t *data, uint16_t size){
	HAL_StatusTypeDef status;

	status = HAL_SPI_Transmit(this->pSpi, data, size, 1000);

	return status;
}

HAL_StatusTypeDef W25Q64_SPI_Receive_Data(MEMORY * this,uint8_t *data, uint16_t size){
	HAL_StatusTypeDef status;

	status = HAL_SPI_Receive(this->pSpi, data, size, 1000);

	return status;
}

void W25Q64_Set_ChipSelect_Low(MEMORY * this){
	HAL_GPIO_WritePin(this->CS_port, this->CS_Pin, GPIO_PIN_RESET);
}

void W25Q64_Set_ChipSelect_High(MEMORY * this){
	HAL_GPIO_WritePin(this->CS_port, this->CS_Pin, GPIO_PIN_SET);
}

uint8_t W25Q64_Init(MEMORY * this){
	this->CS_port=W25Q64_CS_GPIO_Port;
	this->CS_Pin=W25Q64_CS_Pin;
	this->pSpi=&hspi3;


	W25Q64_ResetFlash(this);
	W25Q64_get_JEDEC_ID(this);

	if(W25Q64_WIBOND_ID	 == this->manufacturer_ID && W25Q64_SPI_DEVICE_ID == this->memory_type && W25Q64_CAPACITY_64_MBIT	 == this->capacity)
		return HAL_OK;
	else
		return HAL_ERROR;
}


void W25Q64_ResetFlash(MEMORY * this){
	uint8_t data_to_send[] = { W25Q64_ENABLE_RESET	, W25Q64_RESET };

	W25Q64_Set_ChipSelect_Low(this);
	W25Q64_SPI_Transmit_Data(this,data_to_send, 1);
	W25Q64_Set_ChipSelect_High(this);

    W25Q64_Set_ChipSelect_Low(this);
	W25Q64_SPI_Transmit_Data(this,&data_to_send[1], 1);
	W25Q64_Set_ChipSelect_High(this);
}

void W25Q64_get_JEDEC_ID(MEMORY * this){
	uint8_t data_to_send = 0x9F;
	uint8_t receive_data[3] = { 0, 0, 0 };

	W25Q64_Set_ChipSelect_Low(this);

	W25Q64_SPI_Transmit_Data(this,&data_to_send, 1);
	W25Q64_SPI_Receive_Data(this,receive_data, 3);

	W25Q64_Set_ChipSelect_High(this);

	this->manufacturer_ID = receive_data[0];
	this->memory_type = receive_data[1];
	this->capacity = receive_data[2];
}
